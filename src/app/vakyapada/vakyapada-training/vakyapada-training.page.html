<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/vakyapada"></ion-back-button>
    </ion-buttons>
    <ion-title>{{selectedSloka?.title}} - Training</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="vakyapada-training-content">
  <!-- Back Button Section -->
  <div class="back-button-section">
    <ion-button (click)="goBack()" fill="clear" size="large">
      <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
      Back to VƒÅkyapƒÅ·π≠ha
    </ion-button>
  </div>

  <!-- Training Interface -->
  @if (selectedSloka) {
    <div class="training-interface">
      <div class="training-header">
        <h3>üéØ Practicing: {{selectedSloka.title}}</h3>
        <div class="overall-progress">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="overallProgress"></div>
          </div>
          <p>Line {{currentLineIndex + 1}} of {{selectedSloka.lines.length}} | Overall Progress: {{overallProgress}}%</p>
        </div>
      </div>
      <!-- Current Line Display -->
      <div class="line-display-panel">
        <div class="line-header">
          <h4>Line {{currentLineIndex + 1}}</h4>
          <div class="line-attempts">
            @for (attempt of currentLine.attempts; track attempt; let i = $index) {
              <span
                [ngClass]="getAttemptClass(attempt)">
                ‚óè
              </span>
            }
            <span class="attempts-text">{{currentLine.successfulAttempts}}/3 successful attempts</span>
          </div>
        </div>
        <div class="current-line-content">
          <div class="line-devanagari" [ngClass]="{'highlighting': isPlaying}">
            {{currentLine.devanagari}}
          </div>
          <div class="line-roman" [ngClass]="{'highlighting': isPlaying}">
            {{currentLine.roman}}
          </div>
          <div class="line-meaning">
            {{currentLine.meaning}}
          </div>
        </div>
        <!-- Practice Mode Steps -->
        <div class="practice-modes">
          <div class="mode-tabs">
            @for (mode of practiceModes; track mode; let i = $index) {
              <ion-button
                [fill]="currentPracticeMode === i ? 'solid' : 'outline'"
                [color]="currentPracticeMode === i ? 'secondary' : 'medium'"
                (click)="setPracticeMode(i)"
                [disabled]="!isModeUnlocked(i)"
                >
                <ion-icon [name]="mode.icon" slot="start"></ion-icon>
                {{mode.name}}
                @if (!isModeUnlocked(i)) {
                  <ion-icon name="lock-closed-outline" slot="end"></ion-icon>
                }
              </ion-button>
            }
          </div>
          <div class="current-mode-content">
            <div class="mode-description">
              <h5>{{practiceModes[currentPracticeMode].name}}</h5>
              <p>{{practiceModes[currentPracticeMode].description}}</p>
            </div>
            <!-- Audio Controls -->
            @if (currentPracticeMode <= 2) {
              <div class="audio-controls">
                <ion-button (click)="playLineAudio()" [disabled]="isPlaying" color="primary">
                  <ion-icon name="play-circle-outline" slot="start"></ion-icon>
                  {{isPlaying ? 'Playing...' : 'Play Line'}}
                </ion-button>
                <ion-button (click)="repeatLineAudio()" color="tertiary">
                  <ion-icon name="repeat-outline" slot="start"></ion-icon>
                  Repeat 3x
                </ion-button>
              </div>
            }
            <!-- Recording Controls -->
            <div class="recording-controls">
              <ion-button
                (click)="startRecording()"
                [disabled]="isRecording || (currentPracticeMode === 0 && !hasHeardAudio)"
                color="danger"
                >
                <ion-icon name="mic-outline" slot="start"></ion-icon>
                {{isRecording ? 'Recording...' : 'Record Your Attempt'}}
              </ion-button>
              @if (recordingFeedback) {
                <div class="recording-feedback">
                  <div class="feedback-score" [ngClass]="feedbackClass">
                    {{recordingFeedback}}
                  </div>
                </div>
              }
            </div>
            <!-- Text Display Controls -->
            @if (currentPracticeMode === 2) {
              <div class="text-controls">
                <ion-button (click)="toggleTextVisibility()" fill="outline">
                  <ion-icon [name]="textVisible ? 'eye-off-outline' : 'eye-outline'" slot="start"></ion-icon>
                  {{textVisible ? 'Hide Text' : 'Show Text'}}
                </ion-button>
              </div>
            }
          </div>
        </div>
        <!-- Navigation Controls -->
        <div class="navigation-controls">
          <ion-button
            (click)="previousLine()"
            [disabled]="currentLineIndex === 0"
            fill="outline"
            >
            <ion-icon name="chevron-back-outline" slot="start"></ion-icon>
            Previous Line
          </ion-button>
          <ion-button
            (click)="nextLine()"
            [disabled]="currentLineIndex === selectedSloka.lines.length - 1"
            fill="outline"
            >
            Next Line
            <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
          </ion-button>
          <!-- Quick Test Button for Development -->
          <ion-button
            (click)="markCurrentLineAsComplete()"
            color="success"
            size="small"
            fill="outline"
            >
            <ion-icon name="checkmark-outline" slot="start"></ion-icon>
            Mark Complete (Test)
          </ion-button>
        </div>
      </div>
      <!-- Lines Progress Overview -->
      <div class="lines-progress">
        <h4>üìã Lines Progress</h4>
        <div class="lines-grid">
          @for (line of selectedSloka.lines; track line; let i = $index) {
            <div
              class="line-progress-item"
          [ngClass]="{
            'completed': line.mastered,
            'current': i === currentLineIndex,
            'locked': !isLineUnlocked(i)
          }"
              >
              <div class="line-number">{{i + 1}}</div>
              <div class="line-preview">{{line.roman.substring(0, 30)}}...</div>
              <div class="line-status">
                @if (line.mastered) {
                  <ion-icon
                    name="checkmark-circle"
                    color="success"
                  ></ion-icon>
                }
                @if (!isLineUnlocked(i)) {
                  <ion-icon
                    name="lock-closed-outline"
                    color="medium"
                  ></ion-icon>
                }
                @if (!line.mastered && isLineUnlocked(i)) {
                  <span class="attempts-count">
                    {{line.successfulAttempts}}/3
                  </span>
                }
              </div>
            </div>
          }
        </div>
      </div>
      <!-- Completion Section -->
      @if (isSlokaCompleted()) {
        <div class="completion-section">
          <div class="completion-card">
            <ion-icon name="trophy" color="warning"></ion-icon>
            <h3>üéâ ≈öloka Mastered!</h3>
            <p>Excellent! You've mastered all lines with perfect flow. Ready for the complete recitation?</p>
            <div class="completion-actions">
              <ion-button (click)="practiceFullSloka()" color="success">
                <ion-icon name="play-circle-outline" slot="start"></ion-icon>
                Practice Full ≈öloka
              </ion-button>
              <ion-button (click)="earnBadge()" color="warning">
                <ion-icon name="medal-outline" slot="start"></ion-icon>
                Claim Mastery Badge
              </ion-button>
            </div>
          </div>
        </div>
      }
    </div>
  }

  <!-- Gamification Section -->
  <div class="gamification-section">
    <h2>üèÜ Your Achievements</h2>

    <div class="stats-grid">
      <div class="stat-card">
        <ion-icon name="flame-outline" color="danger"></ion-icon>
        <div class="stat-content">
          <h3>{{streakDays}}</h3>
          <p>Day Streak</p>
        </div>
      </div>

      <div class="stat-card">
        <ion-icon name="star-outline" color="warning"></ion-icon>
        <div class="stat-content">
          <h3>{{totalPoints}}</h3>
          <p>Points Earned</p>
        </div>
      </div>

      <div class="stat-card">
        <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
        <div class="stat-content">
          <h3>{{completedSlokas}}</h3>
          <p>Slokas Mastered</p>
        </div>
      </div>

      <div class="stat-card">
        <ion-icon name="time-outline" color="tertiary"></ion-icon>
        <div class="stat-content">
          <h3>{{practiceMinutes}}</h3>
          <p>Minutes Practiced</p>
        </div>
      </div>
    </div>

    <div class="badges-section">
      <h3>ü•á Earned Badges</h3>
      <div class="badges-grid">
        @for (badge of earnedBadges; track badge) {
          <div class="badge-item">
            <ion-icon [name]="badge.icon" [color]="badge.color"></ion-icon>
            <span>{{badge.name}}</span>
          </div>
        }
        @for (badge of lockedBadges; track badge) {
          <div class="badge-item locked">
            <ion-icon name="lock-closed-outline" color="medium"></ion-icon>
            <span>{{badge.name}}</span>
          </div>
        }
      </div>
    </div>
  </div>
</ion-content>
